name: Build and Release Desktop App

on:
  push:
    tags:
      - 'desktop-v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., desktop-v0.1.0)'
        required: true

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always

jobs:
  build-desktop:
    name: Build Desktop App (${{ matrix.platform }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # macOS ARM64 (Apple Silicon)
          - platform: macos-arm64
            os: macos-latest
            rust_target: aarch64-apple-darwin
            tauri_target: aarch64-apple-darwin
            binary_name: safe-coder
            bundle_ext: dmg

          # macOS x86_64 (Intel)
          - platform: macos-x64
            os: macos-latest
            rust_target: x86_64-apple-darwin
            tauri_target: x86_64-apple-darwin
            binary_name: safe-coder
            bundle_ext: dmg

          # Linux x86_64
          - platform: linux-x64
            os: ubuntu-22.04
            rust_target: x86_64-unknown-linux-gnu
            tauri_target: x86_64-unknown-linux-gnu
            binary_name: safe-coder
            bundle_ext: AppImage

          # Windows x86_64
          - platform: windows-x64
            os: windows-latest
            rust_target: x86_64-pc-windows-msvc
            tauri_target: x86_64-pc-windows-msvc
            binary_name: safe-coder.exe
            bundle_ext: msi

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.rust_target }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Linux dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libappindicator3-dev \
            librsvg2-dev \
            patchelf \
            libssl-dev \
            libgtk-3-dev

      - name: Build safe-coder binary
        run: cargo build --release --target ${{ matrix.rust_target }}

      - name: Prepare binary for Tauri bundling
        shell: bash
        run: |
          mkdir -p desktop/src-tauri/binaries
          # Copy binary with target triple suffix for Tauri
          if [[ "${{ runner.os }}" == "Windows" ]]; then
            cp target/${{ matrix.rust_target }}/release/${{ matrix.binary_name }} desktop/src-tauri/binaries/safe-coder-${{ matrix.tauri_target }}.exe
          else
            cp target/${{ matrix.rust_target }}/release/${{ matrix.binary_name }} desktop/src-tauri/binaries/safe-coder-${{ matrix.tauri_target }}
            chmod +x desktop/src-tauri/binaries/safe-coder-${{ matrix.tauri_target }}
          fi
          ls -la desktop/src-tauri/binaries/

      - name: Install npm dependencies
        working-directory: desktop
        run: npm ci

      - name: Build Tauri app
        working-directory: desktop
        run: npm run tauri build -- --target ${{ matrix.tauri_target }}

      - name: Find built artifacts
        id: artifacts
        shell: bash
        run: |
          echo "Searching for artifacts..."
          if [[ "${{ runner.os }}" == "Linux" ]]; then
            APPIMAGE=$(find desktop/src-tauri/target/${{ matrix.tauri_target }}/release/bundle -name "*.AppImage" -type f | head -n1)
            DEB=$(find desktop/src-tauri/target/${{ matrix.tauri_target }}/release/bundle -name "*.deb" -type f | head -n1)
            echo "appimage=$APPIMAGE" >> $GITHUB_OUTPUT
            echo "deb=$DEB" >> $GITHUB_OUTPUT
          elif [[ "${{ runner.os }}" == "macOS" ]]; then
            DMG=$(find desktop/src-tauri/target/${{ matrix.tauri_target }}/release/bundle -name "*.dmg" -type f | head -n1)
            echo "dmg=$DMG" >> $GITHUB_OUTPUT
          elif [[ "${{ runner.os }}" == "Windows" ]]; then
            MSI=$(find desktop/src-tauri/target/${{ matrix.tauri_target }}/release/bundle -name "*.msi" -type f | head -n1)
            echo "msi=$MSI" >> $GITHUB_OUTPUT
          fi

      - name: Upload macOS artifact
        if: runner.os == 'macOS'
        uses: actions/upload-artifact@v4
        with:
          name: safe-coder-desktop-${{ matrix.platform }}
          path: ${{ steps.artifacts.outputs.dmg }}

      - name: Upload Linux artifacts
        if: runner.os == 'Linux'
        uses: actions/upload-artifact@v4
        with:
          name: safe-coder-desktop-${{ matrix.platform }}
          path: |
            ${{ steps.artifacts.outputs.appimage }}
            ${{ steps.artifacts.outputs.deb }}

      - name: Upload Windows artifact
        if: runner.os == 'Windows'
        uses: actions/upload-artifact@v4
        with:
          name: safe-coder-desktop-${{ matrix.platform }}
          path: ${{ steps.artifacts.outputs.msi }}

  release-desktop:
    name: Create Desktop Release
    needs: build-desktop
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${{ github.ref_name }}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts
        run: find artifacts -type f | head -50

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: Safe Coder Desktop ${{ steps.version.outputs.version }}
          draft: false
          prerelease: false
          files: artifacts/**/*
          body: |
            ## Safe Coder Desktop App

            **Version:** ${{ steps.version.outputs.version }}

            ### Downloads

            | Platform | Download |
            |----------|----------|
            | macOS (Apple Silicon) | `Safe Coder_*_aarch64.dmg` |
            | macOS (Intel) | `Safe Coder_*_x64.dmg` |
            | Linux | `Safe Coder_*.AppImage` or `safe-coder_*.deb` |
            | Windows | `Safe Coder_*.msi` |

            ### Installation

            **macOS:**
            1. Download the `.dmg` file for your Mac (Apple Silicon or Intel)
            2. Open the DMG and drag Safe Coder to Applications
            3. On first launch, right-click and select "Open" to bypass Gatekeeper

            **Linux:**
            - **AppImage:** Make executable with `chmod +x` and run directly
            - **Debian/Ubuntu:** Install with `sudo dpkg -i safe-coder_*.deb`

            **Windows:**
            1. Download and run the `.msi` installer
            2. Follow the installation wizard

            ### Configuration

            Create a `safecoder.json` in your project directory or set environment variables:

            ```json
            {
              "llm": {
                "provider": "openrouter",
                "model": "anthropic/claude-sonnet-4-20250514",
                "max_tokens": 8192
              }
            }
            ```

            Or set `OPENROUTER_API_KEY`, `ANTHROPIC_API_KEY`, or `OPENAI_API_KEY` environment variable.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
